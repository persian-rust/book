## کار با متغیرهای محیطی

ما باینری `minigrep` را با افزودن یک ویژگی اضافی بهبود می‌دهیم: گزینه‌ای برای جستجوی حساس‌نبودن به حروف کوچک و بزرگ که کاربر می‌تواند از طریق یک متغیر محیطی آن را فعال کند. می‌توانستیم این ویژگی را به‌صورت گزینه‌ای در خط فرمان پیاده‌سازی کنیم و از کاربران بخواهیم که هر بار آن را وارد کنند، اما با استفاده از یک متغیر محیطی، به کاربران اجازه می‌دهیم که فقط یک‌بار این متغیر را تنظیم کنند و در کل آن نشست ترمینال، تمام جستجوهای آن‌ها به‌صورت حساس‌نبودن به حروف انجام شود.

### نوشتن یک تست شکست‌خورده برای تابع `search_case_insensitive`

ابتدا تابع جدیدی به نام `search_case_insensitive` به کتابخانه `minigrep` اضافه می‌کنیم که زمانی فراخوانی می‌شود که متغیر محیطی مقدار داشته باشد. ما همچنان از فرایند توسعه آزمون‌محور (TDD) پیروی می‌کنیم، بنابراین گام اول، نوشتن یک تست شکست‌خورده است. یک تست جدید برای تابع `search_case_insensitive` اضافه می‌کنیم و نام تست قبلی‌مان را از `one_result` به `case_sensitive` تغییر می‌دهیم تا تفاوت بین این دو تست واضح‌تر شود، همان‌طور که در لیست 12-20 نشان داده شده است.

<Listing number="12-20" file-name="src/lib.rs" caption="افزودن یک تست شکست‌خورده جدید برای تابع غیرحساس به حروف کوچک و بزرگ که قصد داریم اضافه کنیم">

```rust,ignore,does_not_compile
{{#rustdoc_include ../listings/ch12-an-io-project/listing-12-20/src/lib.rs:here}}
```

</Listing>

توجه کنید که ما متن تست قدیمی را نیز ویرایش کرده‌ایم. ما یک خط جدید با متن `"Duct tape."` با 
حرف بزرگ _D_ اضافه کرده‌ایم که نباید با عبارت جستجو `"duct"` در حالت حساس به حروف کوچک و 
بزرگ مطابقت داشته باشد. تغییر دادن تست قدیمی به این صورت کمک می‌کند که مطمئن شویم عملکرد 
جستجوی حساس به حروف کوچک و بزرگ که قبلاً پیاده‌سازی کرده‌ایم به طور تصادفی شکسته نمی‌شود. 
این تست باید اکنون عبور کند و همچنان باید عبور کند در حالی که ما روی جستجوی غیرحساس به حروف 
کار می‌کنیم.

تست جدید برای جستجوی غیرحساس به حروف کوچک و بزرگ از `"rUsT"` به عنوان عبارت جستجو استفاده 
می‌کند. در تابع `search_case_insensitive` که قصد داریم اضافه کنیم، عبارت جستجوی `"rUsT"` 
باید با خط حاوی `"Rust:"` با حرف بزرگ _R_ و خط `"Trust me."` مطابقت داشته باشد، حتی اگر هر 
دو حالت متفاوتی نسبت به عبارت جستجو داشته باشند. این تست شکست‌خورده ما است و به دلیل اینکه 
هنوز تابع `search_case_insensitive` تعریف نشده است، کامپایل نخواهد شد. می‌توانید یک 
پیاده‌سازی موقتی که همیشه یک وکتور خالی برمی‌گرداند اضافه کنید، مشابه کاری که برای تابع 
`search` در لیستینگ 12-16 انجام دادیم تا تست کامپایل شده و شکست بخورد.

### پیاده‌سازی تابع `search_case_insensitive`

تابع `search_case_insensitive` که در لیستینگ 12-21 نشان داده شده است، تقریباً مشابه تابع 
`search` خواهد بود. تنها تفاوت این است که ما عبارت جستجو و هر خط را کوچک‌حرف می‌کنیم تا 
صرف‌نظر از مورد ورودی‌ها، هنگام بررسی اینکه آیا خط شامل عبارت جستجو است، هر دو به یک مورد 
تبدیل شوند.

<Listing number="12-21" file-name="src/lib.rs" caption="تعریف تابع `search_case_insensitive` برای کوچک‌حرف کردن عبارت جستجو و خط قبل از مقایسه آنها">

```rust,noplayground
{{#rustdoc_include ../listings/ch12-an-io-project/listing-12-21/src/lib.rs:here}}
```

</Listing>

ابتدا رشته `query` را به حروف کوچک تبدیل می‌کنیم و آن را در متغیر جدیدی با همان نام ذخیره می‌کنیم و مقدار اصلی `query` را شَدو (shadow) می‌کنیم. فراخوانی `to_lowercase` بر روی `query` ضروری است تا صرف‌نظر از این‌که کاربر عبارت مورد جستجوی خود را به صورت `"rust"`، `"RUST"`، `"Rust"` یا `"rUsT"` وارد کند، ما با آن گویی که `"rust"` وارد شده است برخورد کنیم و نسبت به حروف کوچک و بزرگ حساس نباشیم. هرچند `to_lowercase` نگاشت پایه‌ی Unicode را انجام می‌دهد، اما صد درصد دقیق نخواهد بود. اگر قصد نوشتن یک برنامه واقعی را داشتیم، نیاز به کار بیشتری در این بخش بود، اما از آن‌جا که این بخش در مورد متغیرهای محیطی است، نه Unicode، در همین حد باقی می‌مانیم.

توجه کنید که اکنون `query` یک رشته (`String`) به جای برش رشته (`string slice`) است، زیرا 
فراخوانی `to_lowercase` داده‌های جدید ایجاد می‌کند به جای اینکه به داده‌های موجود اشاره کند. 
به عنوان مثال، بگویید عبارت جستجو `"rUsT"` است: آن رشته شامل یک `u` یا `t` کوچک نیست که بتوانیم 
استفاده کنیم، بنابراین باید یک `String` جدید شامل `"rust"` تخصیص دهیم. وقتی اکنون `query` را 
به عنوان یک آرگومان به متد `contains` منتقل می‌کنیم، نیاز داریم که یک علامت `&` اضافه کنیم 
چون امضای `contains` به گونه‌ای تعریف شده است که یک برش رشته دریافت می‌کند.

بعداً یک فراخوانی به `to_lowercase` بر روی هر `line` اضافه می‌کنیم تا همه کاراکترها کوچک‌حرف 
شوند. اکنون که `line` و `query` را به کوچک‌حرف تبدیل کرده‌ایم، مطمئن می‌شویم که مطابقت‌ها 
صرف‌نظر از مورد عبارت جستجو پیدا شوند.

بیایید ببینیم آیا این پیاده‌سازی تست‌ها را پاس می‌کند یا خیر:

```console
{{#include ../listings/ch12-an-io-project/listing-12-21/output.txt}}
```

عالی! تست‌ها پاس شدند. حالا بیایید تابع جدید `search_case_insensitive` را از تابع `run` 
فراخوانی کنیم. ابتدا یک گزینه پیکربندی به ساختار `Config` اضافه می‌کنیم تا بین جستجوی حساس 
به حروف کوچک و بزرگ و غیرحساس به حروف کوچک و بزرگ سوئیچ کنیم. افزودن این فیلد باعث ایجاد 
خطاهای کامپایل می‌شود زیرا هنوز این فیلد را در هیچ جا مقداردهی نکرده‌ایم:

<span class="filename">Filename: src/main.rs</span>

```rust,ignore,does_not_compile
{{#rustdoc_include ../listings/ch12-an-io-project/listing-12-22/src/main.rs:here}}
```

We added the `ignore_case` field that holds a Boolean. Next, we need the `run`
function to check the `ignore_case` field’s value and use that to decide
whether to call the `search` function or the `search_case_insensitive`
function, as shown in Listing 12-22. This still won’t compile yet.

<Listing number="12-22" file-name="src/main.rs" caption="Calling either `search` or `search_case_insensitive` based on the value in `config.ignore_case`">

```rust,ignore,does_not_compile
{{#rustdoc_include ../listings/ch12-an-io-project/listing-12-22/src/main.rs:there}}
```

</Listing>

در نهایت، باید بررسی کنیم که آیا متغیر محیطی تنظیم شده است یا خیر. توابع مربوط به کار با متغیرهای محیطی در ماژول `env` از کتابخانه استاندارد قرار دارند که در بالای فایل *src/main.rs* از قبل در scope قرار دارد. برای بررسی اینکه آیا متغیر محیطی‌ای به نام `IGNORE_CASE` مقداری دارد یا نه، از تابع `var` در ماژول `env` استفاده می‌کنیم، همان‌طور که در لیست 12-23 نشان داده شده است.

<Listing number="12-23" file-name="src/main.rs" caption="بررسی وجود مقدار در متغیر محیطی با نام `IGNORE_CASE`">

```rust,ignore,noplayground
{{#rustdoc_include ../listings/ch12-an-io-project/listing-12-23/src/main.rs:here}}
```

</Listing>

اینجا یک متغیر جدید به نام `ignore_case` ایجاد می‌کنیم. برای مقداردهی آن، تابع `env::var` را 
فراخوانی کرده و نام متغیر محیطی `IGNORE_CASE` را به آن می‌دهیم. تابع `env::var` یک `Result` 
برمی‌گرداند که در صورت تنظیم بودن متغیر محیطی به هر مقداری، مقدار `Ok` با مقدار متغیر محیطی را 
دارد. اگر متغیر محیطی تنظیم نشده باشد، مقدار `Err` برگردانده می‌شود.

ما از متد `is_ok` روی `Result` استفاده می‌کنیم تا بررسی کنیم که آیا متغیر محیطی تنظیم شده است، 
که نشان می‌دهد برنامه باید جستجو را به صورت غیرحساس به حروف کوچک و بزرگ انجام دهد. اگر متغیر 
محیطی `IGNORE_CASE` به هیچ مقداری تنظیم نشده باشد، `is_ok` مقدار `false` برمی‌گرداند و برنامه 
جستجو را به صورت حساس به حروف کوچک و بزرگ انجام می‌دهد. ما به مقدار متغیر محیطی نیازی نداریم، فقط 
می‌خواهیم بررسی کنیم که آیا تنظیم شده است یا نه. بنابراین از `is_ok` به جای متدهایی مانند 
`unwrap`، `expect` یا دیگر متدهای مرتبط با `Result` استفاده می‌کنیم.

ما مقدار متغیر `ignore_case` را به نمونه `Config` منتقل می‌کنیم تا تابع `run` بتواند این مقدار 
را بخواند و تصمیم بگیرد که آیا باید تابع `search_case_insensitive` یا `search` را فراخوانی کند.

### امتحان کردن برنامه

حالا بیایید برنامه را امتحان کنیم! ابتدا برنامه را بدون تنظیم متغیر محیطی و با عبارت جستجوی 
`to` اجرا می‌کنیم. این عبارت باید با هر خطی که شامل کلمه _to_ به صورت تمام حروف کوچک باشد، 
مطابقت داشته باشد:

```console
$ cargo run -- to poem.txt
```

برنامه همچنان باید به درستی کار کند و تنها خطوطی که کاملاً با عبارت مطابقت دارند را برگرداند. 
حالا برنامه را با متغیر محیطی `IGNORE_CASE` که به مقدار `1` تنظیم شده است اجرا می‌کنیم و 
همان عبارت جستجو _to_ را امتحان می‌کنیم:

```console
$ IGNORE_CASE=1 cargo run -- to poem.txt
```

در صورت استفاده از PowerShell، نیاز است که متغیر محیطی را تنظیم کنید و سپس برنامه را به صورت 
دستورات جداگانه اجرا کنید:

```console
PS> $Env:IGNORE_CASE=1; cargo run -- to poem.txt
```

این دستور باعث می‌شود که `IGNORE_CASE` برای مدت زمان نشست ترمینال شما تنظیم باقی بماند. می‌توانید 
آن را با دستور `Remove-Item` حذف کنید:

```console
PS> Remove-Item Env:IGNORE_CASE
```

برنامه باید خطوطی که شامل _to_ هستند و ممکن است حروف بزرگ داشته باشند را برگرداند:

```console
Are you nobody, too?
How dreary to be somebody!
To tell your name the livelong day
To an admiring bog!
```

عالی! حالا برنامه `minigrep` ما می‌تواند جستجوهای غیرحساس به حروف کوچک و بزرگ را انجام دهد که 
با یک متغیر محیطی کنترل می‌شود. حالا شما می‌دانید چگونه گزینه‌هایی را که از طریق آرگومان‌های 
خط فرمان یا متغیرهای محیطی تنظیم می‌شوند مدیریت کنید.

برخی برنامه‌ها اجازه می‌دهند که آرگومان‌ها و متغیرهای محیطی برای یک پیکربندی واحد استفاده شوند. 
در این موارد، برنامه‌ها تصمیم می‌گیرند که یکی از آن‌ها اولویت داشته باشد. برای تمرین بیشتر، 
سعی کنید حساسیت به حروف کوچک و بزرگ را از طریق یک آرگومان خط فرمان یا یک متغیر محیطی کنترل کنید. 
تصمیم بگیرید که در صورت تنظیم یکی به حساس و دیگری به غیرحساس بودن، آرگومان خط فرمان یا متغیر 
محیطی باید اولویت داشته باشد.

ماژول `std::env` ویژگی‌های مفید بسیاری برای کار با متغیرهای محیطی دارد: مستندات آن را بررسی کنید 
تا ببینید چه امکاناتی در دسترس است.
